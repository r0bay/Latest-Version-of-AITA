name: iOS TestFlight

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-and-upload:
    runs-on: macos-14
    timeout-minutes: 60

    env:
      WORKSPACE: ios/App/App.xcworkspace
      SCHEME: App
      CONFIGURATION: Release
      ARCHIVE_PATH: ${{ runner.temp }}/App.xcarchive
      IPA_DIR: ${{ runner.temp }}/ipa
      TEAM_ID: ${{ secrets.TEAM_ID }}                 # e.g. US86BZ3GH5
      BUNDLE_ID: ${{ secrets.BUNDLE_ID }}             # e.g. app.randomaita.final
      PROFILE_NAME: ${{ secrets.PROFILE_NAME }}       # e.g. RandomAITAFinal_AppStore_New

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ruby & Fastlane
        run: |
          if ! command -v fastlane >/dev/null 2>&1; then
            sudo gem install fastlane --no-document
          fi

      - name: CocoaPods
        run: |
          sudo gem install cocoapods --no-document
          cd ios/App
          pod repo update
          pod install
          cd ../..

      # --- Install signing material (p12 + provisioning profile) ---
      - name: Create build keychain & import certificate
        shell: bash
        env:
          CERT_P12_BASE64: ${{ secrets.CERT_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        run: |
          set -euo pipefail
          KEYCHAIN=build.keychain
          security create-keychain -p "" "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security unlock-keychain -p "" "$KEYCHAIN"
          security set-keychain-settings -lut 7200 "$KEYCHAIN"

          # decode p12
          printf %s "$CERT_P12_BASE64" | base64 --decode > /tmp/cert.p12

          # quick verify
          if command -v openssl >/dev/null 2>&1; then
            if ! openssl pkcs12 -in /tmp/cert.p12 -passin "pass:${P12_PASSWORD}" -nokeys -info >/dev/null 2>&1; then
              echo "ERROR: p12 password wrong or file corrupt"; exit 1
            fi
          fi

          # import
          security import /tmp/cert.p12 -k "$KEYCHAIN" -P "${P12_PASSWORD}" \
            -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/xcodebuild
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$KEYCHAIN"

      - name: Install provisioning profile
        shell: bash
        env:
          MOBILEPROVISION_BASE64: ${{ secrets.MOBILEPROVISION_BASE64 }}
        run: |
          set -euo pipefail
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          printf %s "$MOBILEPROVISION_BASE64" | base64 --decode > /tmp/profile.mobileprovision
          PROFILE_PLIST=$(/usr/bin/security cms -D -i /tmp/profile.mobileprovision)
          PROFILE_UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<<"$PROFILE_PLIST")
          echo "Using provisioning profile UUID: $PROFILE_UUID"
          cp /tmp/profile.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/$PROFILE_UUID.mobileprovision"

      # --- Build archive (no re-sign at export later) ---
      - name: Bump build number
        run: |
          BN=$(date +%s)
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BN" ios/App/App/Info.plist
          echo "Build number -> $BN"

      - name: Xcode archive
        run: |
          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration "$CONFIGURATION" \
            -archivePath "$ARCHIVE_PATH" \
            -destination "generic/platform=iOS" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="${PROFILE_NAME}" \
            OTHER_CODE_SIGN_FLAGS="--keychain build.keychain" \
            clean archive | xcpretty && exit ${PIPESTATUS[0]}

      # --- Package IPA manually (no ExportOptions) ---
      - name: Package IPA (no re-sign)
        run: |
          set -euo pipefail
          APP_DIR="$ARCHIVE_PATH/Products/Applications"
          APP_PATH="$(/bin/ls -1 "$APP_DIR"/*.app | head -1)"
          echo "Found app: $APP_PATH"

          # sanity: codesign must be valid
          codesign -vv "$APP_PATH" && echo "codesign OK"

          mkdir -p "$IPA_DIR/Payload"
          cp -R "$APP_PATH" "$IPA_DIR/Payload/"

          # include SwiftSupport if present
          if [ -d "$ARCHIVE_PATH/SwiftSupport" ]; then
            cp -R "$ARCHIVE_PATH/SwiftSupport" "$IPA_DIR/"
          fi

          (cd "$IPA_DIR" && /usr/bin/zip -qry App.ipa Payload SwiftSupport 2>/dev/null || /usr/bin/zip -qry App.ipa Payload)
          echo "IPA at: $IPA_DIR/App.ipa"

      # --- Upload to TestFlight via API key ---
      - name: Upload to TestFlight (API key)
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_API_KEY_P8: ${{ secrets.ASC_API_KEY_P8 }}   # full PEM text incl BEGIN/END, with newlines
        run: |
          set -euo pipefail
          IPA="$IPA_DIR/App.ipa"
          [ -f "$IPA" ] || { echo "IPA missing"; exit 1; }

          # write .p8 from secret
          mkdir -p "$HOME/.private_keys"
          KEY_PATH="$HOME/.private_keys/AuthKey_${ASC_KEY_ID}.p8"
          printf "%s" "$ASC_API_KEY_P8" > "$KEY_PATH"
          chmod 600 "$KEY_PATH"
          echo "Key size: $(stat -f%z "$KEY_PATH") bytes"

          # build API key json for fastlane
          API_JSON="$HOME/.private_keys/appstore_api_key.json"
          awk 'BEGIN{print "{\042key_id\042:\042'${ASC_KEY_ID}'\042,\042issuer_id\042:\042'${ASC_ISSUER_ID}'\042,\042key\042:\042"} {gsub(/\r/,""); printf "%s\\n",$0} END{print "\042,\042in_house\042:false}"}' "$KEY_PATH" > "$API_JSON"

          fastlane deliver \
            --api_key_path "$API_JSON" \
            --ipa "$IPA" \
            --skip_metadata true \
            --skip_screenshots true \
            --skip_app_version_update true \
            --force

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: App.ipa
          path: ${{ runner.temp }}/ipa/App.ipa

