name: iOS TestFlight Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies & Capacitor sync
        run: |
          set -euo pipefail
          npm ci
          if [ "$(jq -r '.appId' capacitor.config.json)" != "app.randomaita.final" ]; then
            echo "capacitor.config.json.appId is not app.randomaita.final"
            exit 1
          fi
          npx cap sync ios

      - name: Install CocoaPods
        run: |
          set -euo pipefail
          cd ios/App
          pod install --repo-update

      - name: Install provisioning profile
        env:
          PROFILE_BASE64: ${{ secrets.IOS_PROFILE_APP_STORE_BASE64 }}
        run: |
          set -euo pipefail
          mkdir -p "${HOME}/Library/MobileDevice/Provisioning Profiles"
          echo "$PROFILE_BASE64" | base64 --decode --output "${HOME}/Library/MobileDevice/Provisioning Profiles/RandomAITAFinal_AppStore.mobileprovision"

      - name: Install Apple Certificate
        env:
          CERT_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERT }}
          CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
        run: |
          set -euo pipefail
          
          # Create temporary keychain
          KEYCHAIN_NAME="signing_temp.keychain"
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          KEYCHAIN_PATH="${HOME}/Library/Keychains/${KEYCHAIN_NAME}"
          
          echo "Creating keychain: $KEYCHAIN_NAME"
          /usr/bin/security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          /usr/bin/security set-keychain-settings -lut 21600 "$KEYCHAIN_NAME"
          /usr/bin/security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          
          # Add keychain to search list and set as default for this session
          /usr/bin/security list-keychains -d user -s "$KEYCHAIN_NAME"
          /usr/bin/security default-keychain -s "$KEYCHAIN_NAME"
          
          # Decode certificate to temp file
          CERT_FILE=$(mktemp)
          echo "Decoding certificate (base64 length: ${#CERT_BASE64})"
          echo "$CERT_BASE64" | base64 -d > "$CERT_FILE"
          CERT_SIZE=$(wc -c < "$CERT_FILE" | tr -d ' ')
          echo "Certificate file size: $CERT_SIZE bytes"
          
          # --- PRECHECK: prove password is correct and extract cert+key ---
          if ! openssl pkcs12 -in "$CERT_FILE" -passin "pass:${CERT_PASSWORD}" -info -nokeys >/dev/null 2>&1; then
            echo "ERROR: p12 password is incorrect or file is corrupt (OpenSSL check failed)."
            exit 1
          fi
          
          # Extract leaf certificate and private key from the P12
          openssl pkcs12 -in "$CERT_FILE" -passin "pass:${CERT_PASSWORD}" -clcerts -nokeys -out /tmp/dist_cert.cer
          openssl pkcs12 -in "$CERT_FILE" -passin "pass:${CERT_PASSWORD}" -nocerts -nodes -out /tmp/dist_key.pem
          
          # Sanity: show subjects (no secrets printed)
          openssl x509 -in /tmp/dist_cert.cer -noout -subject || true
          
          # --- IMPORT via PEM (avoids PKCS#12 MAC verification issues) ---
          # Import certificate
          /usr/bin/security import /tmp/dist_cert.cer -k "$KEYCHAIN_NAME" -A -t cert -f x509
          
          # Import private key (no password on PEM because we used -nodes)
          /usr/bin/security import /tmp/dist_key.pem -k "$KEYCHAIN_NAME" -A -t priv
          
          # Allow codesign/xcodebuild to use the key (use keychain password)
          /usr/bin/security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_NAME"
          
          # Verify key is usable
          echo "Verifying certificate import..."
          /usr/bin/security find-identity -v -p codesigning "$KEYCHAIN_NAME" || echo "Warning: Could not list identities"
          
          # Clean up temp files
          rm -f "$CERT_FILE" /tmp/dist_cert.cer /tmp/dist_key.pem
          
          echo "âœ“ Certificate imported successfully to $KEYCHAIN_NAME"

      - name: Setup App Store Connect API Key
        env:
          API_KEY_BASE64: ${{ secrets.ASC_KEY_P8_BASE64 }}
          KEY_ID: ${{ secrets.ASC_KEY_ID }}
        run: |
          set -euo pipefail
          mkdir -p "${HOME}/private_keys"
          echo "$API_KEY_BASE64" | base64 --decode --output "${HOME}/private_keys/AuthKey_${KEY_ID}.p8"

      - name: Create export options
        run: |
          set -euo pipefail
          /usr/bin/tee ios/App/exportOptions.plist >/dev/null <<'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
            <dict>
              <key>method</key><string>app-store</string>
              <key>teamID</key><string>US86BZ3GH5</string>
              <key>signingStyle</key><string>manual</string>
              <key>signingCertificate</key><string>Apple Distribution</string>
              <key>provisioningProfiles</key>
              <dict>
                <key>app.randomaita.final</key><string>RandomAITAFinal_AppStore</string>
              </dict>
              <key>uploadSymbols</key><true/>
              <key>compileBitcode</key><false/>
              <key>manageAppVersionAndBuildNumber</key><false/>
            </dict>
          </plist>
          EOF

      - name: Sanity check - show Release signing configuration
        run: |
          set -euo pipefail
          cd ios/App
          xcodebuild -showBuildSettings -workspace App.xcworkspace -scheme App -configuration Release \
            | egrep 'PRODUCT_BUNDLE_IDENTIFIER|CODE_SIGN_STYLE|CODE_SIGN_IDENTITY|PROVISIONING_PROFILE_SPECIFIER|PROVISIONING_PROFILE = |DEVELOPMENT_TEAM'

      - name: Build and archive with Distribution signing
        env:
          TEAM_ID: ${{ secrets.TEAM_ID }}
          BUNDLE_ID: ${{ secrets.BUNDLE_ID }}
          PROFILE_NAME: ${{ secrets.PROFILE_NAME }}
        run: |
          set -euo pipefail
          cd ios/App
          rm -rf "${HOME}/Library/Developer/Xcode/DerivedData"/*

          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -archivePath "$PWD/build/App.xcarchive" \
            -destination "generic/platform=iOS" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "${HOME}/private_keys/AuthKey_${{ secrets.ASC_KEY_ID }}.p8" \
            -authenticationKeyID "${{ secrets.ASC_KEY_ID }}" \
            -authenticationKeyIssuerID "${{ secrets.ASC_ISSUER_ID }}" \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGN_IDENTITY="Apple Distribution" \
            PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
            OTHER_CODE_SIGN_FLAGS="--keychain signing_temp.keychain" \
            clean archive | tee /tmp/archive.log

      - name: Export IPA for App Store distribution
        run: |
          set -euo pipefail
          cd ios/App
          xcodebuild -exportArchive \
            -archivePath "$PWD/build/App.xcarchive" \
            -exportPath "$PWD/build" \
            -exportOptionsPlist "$PWD/exportOptions.plist" \
            -allowProvisioningUpdates \
            -authenticationKeyPath "${HOME}/private_keys/AuthKey_${{ secrets.ASC_KEY_ID }}.p8" \
            -authenticationKeyID "${{ secrets.ASC_KEY_ID }}" \
            -authenticationKeyIssuerID "${{ secrets.ASC_ISSUER_ID }}"

          echo "Export completed. Listing build artifacts..."
          ls -lh build/*.ipa || { echo "IPA file not found"; exit 1; }

      - name: Upload IPA to TestFlight
        run: |
          set -euo pipefail
          IPA_FILE="$(find ios/App/build -name "*.ipa" -type f | head -n 1)"
          if [ -z "${IPA_FILE}" ]; then
            echo "Error: No IPA file found"
            exit 1
          fi
          echo "Uploading ${IPA_FILE} to TestFlight..."
          xcrun altool --upload-app \
            --type ios \
            --file "${IPA_FILE}" \
            --apiKey "${{ secrets.ASC_KEY_ID }}" \
            --apiIssuer "${{ secrets.ASC_ISSUER_ID }}"
          echo "Upload to TestFlight completed successfully!"

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: RandomAITA-${{ github.run_number }}.ipa
          path: ios/App/build/*.ipa
          retention-days: 30
