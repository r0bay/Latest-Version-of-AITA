workflows:
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      groups:
        - apple_credentials
      vars:
        APP_ID: com.randomaita.app
        XCODE_WORKSPACE: "ios/App/App.xcworkspace"
        XCODE_SCHEME: "App"
        BUNDLE_ID: com.randomaita.app
        TEAM_ID: US86BZ3GH5
    scripts:
      - name: Install Node.js dependencies
        script: |
          npm install
      - name: Install CocoaPods dependencies
        script: |
          cd ios/App
          pod install --repo-update
          echo "Verifying CocoaPods installation..."
          ls -la Pods/Target\ Support\ Files/Pods-App/ || echo "Warning: Pods directory not found"
          ls -la App.xcworkspace || echo "Warning: Workspace not found"
          cd ../..
      - name: Create shared scheme (required for workspace builds)
        script: |
          cd ios/App
          # Create scheme directory if it doesn't exist
          mkdir -p App.xcodeproj/xcshareddata/xcschemes
          # Force create the scheme file (overwrite if exists)
          echo "Creating shared scheme: App.xcscheme"
          printf '<?xml version="1.0" encoding="UTF-8"?>\n<Scheme\n   LastUpgradeVersion = "1500"\n   version = "1.7">\n   <BuildAction>\n      <BuildActionEntries>\n         <BuildActionEntry\n            buildForTesting = "YES"\n            buildForRunning = "YES"\n            buildForProfiling = "YES"\n            buildForArchiving = "YES"\n            buildForAnalyzing = "YES">\n            <BuildableReference\n               BuildableIdentifier = "primary"\n               BlueprintIdentifier = "504EC3031FED79650016851F"\n               BuildableName = "App.app"\n               BlueprintName = "App"\n               ReferencedContainer = "container:App.xcodeproj">\n            </BuildableReference>\n         </BuildActionEntry>\n      </BuildActionEntries>\n   </BuildAction>\n   <TestAction>\n      <Testables>\n      </Testables>\n   </TestAction>\n   <LaunchAction\n      buildConfiguration = "Debug"\n      selectedDebuggerIdentifier = "Xcode.DebuggerFoundation.Debugger.LLDB"\n      selectedLauncherIdentifier = "Xcode.DebuggerFoundation.Launcher.LLDB"\n      launchStyle = "0">\n      <BuildableProductRunnable\n         runnableDebuggingMode = "0">\n         <BuildableReference\n            BuildableIdentifier = "primary"\n            BlueprintIdentifier = "504EC3031FED79650016851F"\n            BuildableName = "App.app"\n            BlueprintName = "App"\n            ReferencedContainer = "container:App.xcodeproj">\n         </BuildableReference>\n      </BuildableProductRunnable>\n   </LaunchAction>\n   <ArchiveAction\n      buildConfiguration = "Release"\n      revealArchiveInOrganizer = "YES">\n   </ArchiveAction>\n</Scheme>\n' > App.xcodeproj/xcshareddata/xcschemes/App.xcscheme
          ls -la App.xcodeproj/xcshareddata/xcschemes/
          cd ../..
      - name: Set up code signing settings on Xcode project
        script: |
          cd ios/App
          xcode-project use-profiles \
            --team-id $TEAM_ID \
            --bundle-id $BUNDLE_ID \
            --workspace App.xcworkspace
          cd ../..
      - name: Verify workspace and scheme
        script: |
          echo "Listing schemes in workspace..."
          xcodebuild -workspace "$XCODE_WORKSPACE" -list || echo "Workspace listing failed"
          echo ""
          echo "Listing schemes in project..."
          xcodebuild -project ios/App/App.xcodeproj -list || echo "Project listing failed"
          echo ""
          echo "Checking if scheme file exists..."
          ls -la ios/App/App.xcodeproj/xcshareddata/xcschemes/ || echo "Scheme directory not found"
          echo ""
          echo "Checking workspace contents..."
          ls -la ios/App/App.xcworkspace/contents.xcworkspacedata || echo "Workspace file not found"
      - name: Build ipa for distribution
        script: |
          cd ios/App
          # Try listing schemes again after all setup
          echo "Final scheme check..."
          WORKSPACE_SCHEMES=$(xcodebuild -workspace App.xcworkspace -list 2>/dev/null | grep -A 20 "Schemes:" | grep -v "Schemes:" | xargs || echo "")
          PROJECT_SCHEMES=$(xcodebuild -project App.xcodeproj -list 2>/dev/null | grep -A 20 "Schemes:" | grep -v "Schemes:" | xargs || echo "")
          echo "Workspace schemes: $WORKSPACE_SCHEMES"
          echo "Project schemes: $PROJECT_SCHEMES"
          
          # Ensure archive directory exists
          mkdir -p "$CM_BUILD_DIR"
          ARCHIVE_PATH="$CM_BUILD_DIR/build.xcarchive"
          echo "Archive will be created at: $ARCHIVE_PATH"
          
          # If workspace doesn't have the scheme, try to build using project but with workspace context
          if echo "$WORKSPACE_SCHEMES" | grep -q "App"; then
            echo "Building with workspace (scheme found)..."
            xcodebuild build archive \
              -workspace App.xcworkspace \
              -scheme App \
              -archivePath "$ARCHIVE_PATH" \
              -allowProvisioningUpdates \
              -destination "generic/platform=iOS"
          elif echo "$PROJECT_SCHEMES" | grep -q "App"; then
            echo "Scheme found in project, building with project file..."
            # Build with project but ensure CocoaPods dependencies are available
            xcodebuild build archive \
              -project App.xcodeproj \
              -scheme App \
              -archivePath "$ARCHIVE_PATH" \
              -allowProvisioningUpdates \
              -destination "generic/platform=iOS"
          else
            echo "ERROR: Scheme 'App' not found in workspace or project!"
            echo "Trying to build anyway..."
            xcodebuild build archive \
              -workspace App.xcworkspace \
              -scheme App \
              -archivePath "$ARCHIVE_PATH" \
              -allowProvisioningUpdates \
              -destination "generic/platform=iOS"
          fi
          
          # Verify archive was created
          echo "Checking if archive was created..."
          if [ -d "$ARCHIVE_PATH" ]; then
            echo "SUCCESS: Archive created at $ARCHIVE_PATH"
            ls -la "$ARCHIVE_PATH"
          else
            echo "WARNING: Archive not found at expected path, searching..."
            find . -name "*.xcarchive" -type d
          fi
          cd ../..
      - name: Export IPA
        script: |
          echo "Looking for archive..."
          find . -name "*.xcarchive" -type d 2>/dev/null | head -5
          echo ""
          echo "Checking CM_BUILD_DIR: $CM_BUILD_DIR"
          ls -la "$CM_BUILD_DIR" || echo "CM_BUILD_DIR not found"
          echo ""
          # Try to find the archive
          ARCHIVE_PATH=$(find . -name "*.xcarchive" -type d 2>/dev/null | head -1)
          if [ -z "$ARCHIVE_PATH" ]; then
            ARCHIVE_PATH="$CM_BUILD_DIR/build.xcarchive"
          fi
          echo "Using archive path: $ARCHIVE_PATH"
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "ERROR: Archive not found at $ARCHIVE_PATH"
            echo "Searching for archives..."
            find . -name "*.xcarchive" -type d
            exit 1
          fi
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist export_options.plist \
            -exportPath "$CM_BUILD_DIR"
    artifacts:
      - build/**/*.xcarchive
      - build/**/*.ipa
    publishing:
      email:
        recipients:
          - robbyaw@icloud.com
        notify:
          success: true
          failure: false

