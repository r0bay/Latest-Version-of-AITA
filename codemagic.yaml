workflows:
  ios-workflow:
    name: iOS Workflow
    max_build_duration: 120
    instance_type: mac_mini_m1
    integrations:
      app_store_connect: apple_credentials
    environment:
      groups:
        - apple_credentials
      vars:
        APP_ID: app.randomaita.final
        XCODE_WORKSPACE: "ios/App/App.xcworkspace"
        XCODE_SCHEME: "App"
        BUNDLE_ID: app.randomaita.final
        TEAM_ID: US86BZ3GH5
    scripts:
      - name: Install Node.js dependencies
        script: |
          npm install
      - name: Install CocoaPods dependencies
        script: |
          cd ios/App
          echo "Installing CocoaPods dependencies..."
          pod install --repo-update || {
            echo "Pod install failed, trying without repo update..."
            pod install
          }
          echo "Verifying Pods installation..."
          if [ ! -f "Pods/Target Support Files/Pods-App/Pods-App.release.xcconfig" ]; then
            echo "Warning: Pods config not found, but continuing..."
          else
            echo "✓ Pods installed successfully"
          fi
          echo "Verifying workspace exists..."
          if [ ! -f "App.xcworkspace/contents.xcworkspacedata" ]; then
            echo "ERROR: Workspace file not found!"
            exit 1
          fi
          cd ../..
      - name: Verify scheme exists
        script: |
          cd ios/App
          if [ ! -f "App.xcodeproj/xcshareddata/xcschemes/App.xcscheme" ]; then
            echo "ERROR: Scheme file not found"
            exit 1
          fi
          cd ../..
      - name: Sync Capacitor files
        script: |
          echo "Syncing Capacitor files to iOS directory..."
          npx cap sync ios || {
            echo "Capacitor sync failed!"
            exit 1
          }
          echo "✓ Capacitor sync complete"
          echo "Verifying AppDelegate.swift exists..."
          if [ ! -f "ios/App/App/AppDelegate.swift" ]; then
            echo "ERROR: AppDelegate.swift not found!"
            exit 1
          fi
          echo "✓ AppDelegate.swift found"
          echo "Re-running pod install after Capacitor sync..."
          cd ios/App
          pod install
          cd ../..
      - name: Verify App Store Connect integration
        script: |
          echo "=== Verifying App Store Connect API Integration ==="
          echo "Checking if app-store-connect CLI is available..."
          which app-store-connect || echo "⚠ app-store-connect command not found"
          
          echo "Checking environment variables..."
          echo "BUNDLE_ID: $BUNDLE_ID"
          echo "TEAM_ID: $TEAM_ID"
          
          # Try to test the connection
          echo "Testing App Store Connect API connection..."
          app-store-connect fetch-signing-files --help || echo "⚠ Could not get help for app-store-connect"
      - name: Set up code signing
        script: |
          echo "=== Code Signing Setup ==="
          echo "Bundle ID: $BUNDLE_ID"
          echo "Team ID: $TEAM_ID"
          
          # Verify environment variables are set
          if [ -z "$BUNDLE_ID" ]; then
            echo "ERROR: BUNDLE_ID not set"
            exit 1
          fi
          if [ -z "$TEAM_ID" ]; then
            echo "ERROR: TEAM_ID not set"
            exit 1
          fi
          
          cd ios/App
          # Set DEVELOPMENT_TEAM in project file - this is critical
          awk -v team="$TEAM_ID" '/CODE_SIGN_STYLE = Automatic;/ {print; print "\t\t\tDEVELOPMENT_TEAM = \"" team "\";"; next} {print}' App.xcodeproj/project.pbxproj > App.xcodeproj/project.pbxproj.new && mv App.xcodeproj/project.pbxproj.new App.xcodeproj/project.pbxproj
          sed -i.bak "s/DEVELOPMENT_TEAM = \"[^\"]*\";/DEVELOPMENT_TEAM = \"$TEAM_ID\";/g" App.xcodeproj/project.pbxproj
          
          # Verify DEVELOPMENT_TEAM is set
          if grep -q "DEVELOPMENT_TEAM = \"$TEAM_ID\"" App.xcodeproj/project.pbxproj; then
            echo "✓ DEVELOPMENT_TEAM set correctly"
          else
            echo "✗ Failed to set DEVELOPMENT_TEAM"
            exit 1
          fi
          cd ../..
          
          # Initialize keychain for code signing
          echo "Initializing keychain..."
          keychain initialize
          
          # Use Codemagic's automatic code signing - this will create certificates automatically
          echo "Setting up automatic code signing with Codemagic..."
          echo "This will create certificates automatically via App Store Connect API"
          
          # Initialize keychain and let Codemagic handle certificate creation
          # The key is to use xcode-project use-profiles which uses Codemagic's automatic signing
          cd ios/App
          echo "Applying automatic code signing..."
          xcode-project use-profiles || echo "Note: Profiles may already be applied"
          cd ../..
          
          # Verify certificates are available after Codemagic's automatic setup
          echo "Checking for distribution certificates..."
          CERT_OUTPUT=$(security find-identity -v -p codesigning 2>&1)
          echo "$CERT_OUTPUT"
          
          if echo "$CERT_OUTPUT" | grep -q "iOS Distribution"; then
            echo "✓ iOS Distribution certificates found"
          else
            echo "⚠ No iOS Distribution certificates found yet"
            echo "Certificates will be created automatically during the build process"
            echo "Xcode will create them via -allowProvisioningUpdates"
          fi
      - name: Clean build folder
        script: |
          cd ios/App
          echo "Cleaning build folder..."
          xcodebuild clean \
            -workspace App.xcworkspace \
            -scheme App \
            -configuration Release
          cd ../..
      - name: Build ipa for distribution
        script: |
          cd ios/App
          mkdir -p "$CM_BUILD_DIR"
          ARCHIVE_PATH="$CM_BUILD_DIR/build.xcarchive"
          
          echo "Building archive..."
          echo "Workspace: App.xcworkspace"
          echo "Scheme: App"
          echo "Archive path: $ARCHIVE_PATH"
          echo "Team ID: $TEAM_ID"
          echo "Bundle ID: $BUNDLE_ID"
          
          # Verify Pods are properly installed before building
          echo "Verifying Pods installation..."
          if [ ! -d "Pods/Google-Mobile-Ads-SDK" ]; then
            echo "ERROR: Google-Mobile-Ads-SDK not found in Pods!"
            echo "Running pod install again..."
            pod install
          fi
          
          # Verify workspace file exists
          if [ ! -f "App.xcworkspace/contents.xcworkspacedata" ]; then
            echo "ERROR: Workspace file not found!"
            exit 1
          fi
          
          # Build with automatic provisioning
          # Note: Using -UseModernBuildSystem=1 for better dependency resolution
          xcodebuild archive \
            -workspace App.xcworkspace \
            -scheme App \
            -archivePath "$ARCHIVE_PATH" \
            -allowProvisioningUpdates \
            -destination "generic/platform=iOS" \
            -configuration Release \
            -UseModernBuildSystem=1 \
            DEVELOPMENT_TEAM="$TEAM_ID" \
            CODE_SIGN_STYLE=Automatic \
            SWIFT_VERSION=5.0 \
            SWIFT_OPTIMIZATION_LEVEL="-O" \
            CLANG_ENABLE_MODULES=YES \
            SWIFT_ENABLE_BATCH_MODE=YES \
            2>&1 | tee /tmp/xcodebuild.log || {
            echo "Build failed. Last 150 lines of log:"
            tail -150 /tmp/xcodebuild.log
            echo ""
            echo "Searching for Swift compilation errors:"
            grep -i "error\|failed\|cannot" /tmp/xcodebuild.log | tail -30
            echo ""
            echo "Checking for module import errors:"
            grep -i "google\|admob\|module" /tmp/xcodebuild.log | tail -20
            exit 1
          }
          
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "ERROR: Archive not created at $ARCHIVE_PATH"
            echo "Build log:"
            tail -100 /tmp/xcodebuild.log
            exit 1
          fi
          echo "✓ Archive created successfully at $ARCHIVE_PATH"
          cd ../..
      - name: Export IPA
        script: |
          ARCHIVE_PATH="$CM_BUILD_DIR/build.xcarchive"
          if [ ! -d "$ARCHIVE_PATH" ]; then
            echo "ERROR: Archive not found at $ARCHIVE_PATH"
            exit 1
          fi
          
          # Verify export_options.plist exists and has team ID
          if [ ! -f "export_options.plist" ]; then
            echo "ERROR: export_options.plist not found"
            exit 1
          fi
          
          echo "Exporting IPA with team ID: $TEAM_ID"
          echo "Note: Codemagic should automatically create distribution certificates via App Store Connect API"
          
          # Export - Codemagic's App Store Connect API integration should provide certificates
          xcodebuild -exportArchive \
            -archivePath "$ARCHIVE_PATH" \
            -exportOptionsPlist export_options.plist \
            -exportPath "$CM_BUILD_DIR" \
            -allowProvisioningUpdates
          
          # Verify IPA was created
          IPA_FILE=$(find "$CM_BUILD_DIR" -name "*.ipa" -type f | head -1)
          if [ -n "$IPA_FILE" ]; then
            echo "✓ IPA exported successfully: $IPA_FILE"
            ls -la "$IPA_FILE"
          else
            echo "ERROR: IPA not found after export"
            echo ""
            echo "This error means Codemagic couldn't create distribution certificates."
            echo "Make sure:"
            echo "1. App Store Connect API integration 'apple_credentials' is configured in Codemagic"
            echo "2. The API key has 'App Manager' or 'Admin' role"
            echo "3. The bundle ID 'app.randomaita.final' is registered in App Store Connect"
            echo ""
            echo "Contents of export directory:"
            ls -la "$CM_BUILD_DIR"
            exit 1
          fi
    artifacts:
      - build/**/*.xcarchive
      - build/**/*.ipa
    publishing:
      email:
        recipients:
          - robbyaw@icloud.com
        notify:
          success: true
          failure: true
